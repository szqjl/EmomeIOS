name: iOS Build

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'lib/**'
      - 'ios/**'
      - 'pubspec.yaml'
      - '.github/workflows/ios-build.yml'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-ios:
    name: Build iOS App
    runs-on: macos-latest  # ä½¿ç”¨ macOS runner
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'
          cache: true
      
      - name: ðŸ“¦ Get dependencies
        run: flutter pub get
      
      - name: ðŸ” Verify Flutter setup
        run: flutter doctor -v
      
      - name: ðŸ”§ Generate iOS project structure
        run: |
          # æ£€æŸ¥ iOS é¡¹ç›®ç»“æž„
          if [ ! -f "ios/Runner.xcodeproj/project.pbxproj" ]; then
            echo "âš ï¸ iOS project structure missing, generating..."
            # ä½¿ç”¨ flutter create ç”Ÿæˆ iOS é¡¹ç›®ç»“æž„ï¼Œä½†ä¿ç•™çŽ°æœ‰æ–‡ä»¶
            flutter create --platforms=ios --org com.emofirst --project-name emofirst . || {
              echo "âš ï¸ flutter create failed, trying alternative approach"
              # å¦‚æžœ flutter create å¤±è´¥ï¼Œè‡³å°‘ç¡®ä¿ Flutter ç›®å½•å­˜åœ¨
              mkdir -p ios/Flutter
            }
          else
            echo "âœ… iOS project structure exists"
          fi
          
          # ç¡®ä¿ Flutter ç”Ÿæˆå¿…è¦çš„é…ç½®æ–‡ä»¶
          flutter precache --ios || echo "âš ï¸ precache failed, continuing..."
      
      - name: ðŸ”§ Check project structure
        run: |
          echo "## Project Structure Check" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la ios/ >> $GITHUB_STEP_SUMMARY || echo "ios directory:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          if [ -f "ios/Podfile" ]; then
            echo "âœ… Podfile exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Podfile not found" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f "ios/Runner.xcodeproj/project.pbxproj" ] || [ -f "ios/Runner.xcworkspace/contents.xcworkspacedata" ]; then
            echo "âœ… iOS project structure exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ iOS project structure missing (will be generated)" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸ§¹ Clean build
        run: flutter clean
      
      - name: ðŸ“± Install CocoaPods
        run: |
          sudo gem install cocoapods
          pod --version
      
      - name: ðŸ“± Install CocoaPods dependencies
        run: |
          cd ios
          if [ -f "Podfile" ]; then
            echo "Installing CocoaPods dependencies..."
            pod install --repo-update || {
              echo "âš ï¸ pod install failed, trying without repo-update"
              pod install || echo "âš ï¸ pod install failed completely"
            }
          else
            echo "âš ï¸ Podfile not found, Flutter will handle dependencies"
          fi
          cd ..
          
          # éªŒè¯ iOS é¡¹ç›®ç»“æž„
          if [ ! -f "ios/Runner.xcodeproj/project.pbxproj" ] && [ ! -f "ios/Runner.xcworkspace/contents.xcworkspacedata" ]; then
            echo "âŒ iOS project structure still missing after setup"
            echo "Project structure:"
            ls -la ios/ || true
            exit 1
          fi
      
      - name: ðŸ” Disable code signing requirement
        run: |
          # ç¦ç”¨ Xcode é¡¹ç›®çš„ä»£ç ç­¾åè¦æ±‚
          if [ -f "ios/Runner.xcodeproj/project.pbxproj" ]; then
            echo "Disabling code signing in Xcode project..."
            # ä½¿ç”¨ sed ä¿®æ”¹é¡¹ç›®æ–‡ä»¶ï¼Œç¦ç”¨ä»£ç ç­¾å
            sed -i '' 's/CODE_SIGN_IDENTITY = ".*"/CODE_SIGN_IDENTITY = ""/g' ios/Runner.xcodeproj/project.pbxproj || \
            sed -i 's/CODE_SIGN_IDENTITY = ".*"/CODE_SIGN_IDENTITY = ""/g' ios/Runner.xcodeproj/project.pbxproj || true
            sed -i '' 's/CODE_SIGN_IDENTITY\[sdk=.*\] = ".*"/CODE_SIGN_IDENTITY[sdk=iphoneos*] = ""/g' ios/Runner.xcodeproj/project.pbxproj || \
            sed -i 's/CODE_SIGN_IDENTITY\[sdk=.*\] = ".*"/CODE_SIGN_IDENTITY[sdk=iphoneos*] = ""/g' ios/Runner.xcodeproj/project.pbxproj || true
            sed -i '' 's/DEVELOPMENT_TEAM = ".*"/DEVELOPMENT_TEAM = ""/g' ios/Runner.xcodeproj/project.pbxproj || \
            sed -i 's/DEVELOPMENT_TEAM = ".*"/DEVELOPMENT_TEAM = ""/g' ios/Runner.xcodeproj/project.pbxproj || true
            sed -i '' 's/PROVISIONING_PROFILE_SPECIFIER = ".*"/PROVISIONING_PROFILE_SPECIFIER = ""/g' ios/Runner.xcodeproj/project.pbxproj || \
            sed -i 's/PROVISIONING_PROFILE_SPECIFIER = ".*"/PROVISIONING_PROFILE_SPECIFIER = ""/g' ios/Runner.xcodeproj/project.pbxproj || true
            echo "âœ… Code signing disabled"
          else
            echo "âš ï¸ Xcode project file not found, skipping code signing configuration"
          fi
      
      - name: ðŸ—ï¸ Build iOS (Release)
        run: |
          echo "Starting iOS build..."
          echo "Build configuration: Release, no code signing"
          set +e  # å…è®¸é”™è¯¯ï¼Œä»¥ä¾¿æ•èŽ·é€€å‡ºä»£ç 
          # ä½¿ç”¨çŽ¯å¢ƒå˜é‡å¼ºåˆ¶ç¦ç”¨ä»£ç ç­¾å
          export CODE_SIGN_IDENTITY=""
          export CODE_SIGNING_REQUIRED=NO
          export CODE_SIGNING_ALLOWED=NO
          flutter build ios --release --no-codesign 2>&1 | tee build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          if [ ${BUILD_EXIT_CODE} -ne 0 ]; then
            echo "## âŒ Build Failed (Exit Code: ${BUILD_EXIT_CODE})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Error Details" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -300 build.log >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Project Structure" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            find ios -type f -name "*.xcodeproj" -o -name "*.xcworkspace" -o -name "Podfile" 2>/dev/null | head -10 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "âŒ Build failed with exit code ${BUILD_EXIT_CODE}"
            echo "Last 100 lines of log:"
            tail -100 build.log
            exit ${BUILD_EXIT_CODE}
          fi
          
          echo "âœ… Build completed successfully"
          echo "Checking build output..."
          if [ -d "build/ios/iphoneos" ]; then
            ls -la build/ios/iphoneos/
            echo "âœ… Build output found"
          else
            echo "âš ï¸ Build output directory not found"
            echo "Checking alternative locations..."
            find build -name "*.app" -o -name "*.ipa" 2>/dev/null | head -10
          fi
        env:
          FLUTTER_BUILD_MODE: release
      
      - name: ðŸ“‹ List build output
        if: always()
        run: |
          echo "## Build Output Check" >> $GITHUB_STEP_SUMMARY
          if [ -d "build/ios/iphoneos" ]; then
            echo "âœ… Build output directory exists" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -la build/ios/iphoneos/ >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Build output directory not found" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        continue-on-error: true
        with:
          name: ios-build-artifacts
          path: |
            build/ios/iphoneos/Runner.app
            build/ios/iphoneos/*.dSYM
            build.log
          retention-days: 7
          if-no-files-found: warn
      
      - name: ðŸ“¤ Upload build log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-log
          path: build.log
          retention-days: 7
          if-no-files-found: ignore
      
      - name: ðŸ“Š Build summary
        if: always()
        run: |
          echo "## ðŸ“± iOS Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Flutter Version**: $(flutter --version | head -n 1)" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… Build Successful" >> $GITHUB_STEP_SUMMARY
            echo "Build artifacts are available in the Actions tab for 7 days." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "Please check the build log for details." >> $GITHUB_STEP_SUMMARY
          fi
